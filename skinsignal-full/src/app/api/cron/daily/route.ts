import {NextResponse} from "next/server"; import {withClient} from "@/lib/db"; import {takeSnapshot} from "@/lib/snapshot"; export const dynamic="force-dynamic"; export const runtime="nodejs"; export async function GET(){ try{ type Row={steam_id:string}; const ids=await withClient(async c=>{ const u=await c.query("SELECT steam_id FROM users"); return (u.rows as unknown as Row[]).map(r=>r.steam_id) }); const results:any[]=[]; for(const sid of ids){ try{ const r=await takeSnapshot(sid); results.push({steamId:sid,ok:true,total:r.total_value}) } catch(e:any){ results.push({steamId:sid,ok:false,error:e?.message||"snapshot_failed"}) } } return NextResponse.json({ok:true,results}) } catch(e:any){ return NextResponse.json({ok:false,error:e?.message||"cron_failed"},{status:500}) } }
